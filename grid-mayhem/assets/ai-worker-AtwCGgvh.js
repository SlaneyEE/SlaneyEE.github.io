const I={NORMAL:"NORMAL",BRONZE:"BRONZE",SILVER:"SILVER",GOLD:"GOLD",DIAMOND:"DIAMOND"},O={Basic:"Basic",Square:"Square",LShapeLeft:"LShapeLeft",LShapeRight:"LShapeRight",TShape:"TShape",Line:"Line",ZShapeLeft:"ZShapeLeft",ZShapeRight:"ZShapeRight",UShape:"UShape",CornerShape:"CornerShape",PlusShape:"PlusShape"},N={SELF_REDUCE_SPEED:"SELF_REDUCE_SPEED",SELF_RAINBOW_BLOCK:"SELF_RAINBOW_BLOCK",SELF_REMOVE_EFFECT_BLOCKS:"SELF_REMOVE_EFFECT_BLOCKS",SELF_NUKE:"SELF_NUKE",SELF_TNT_BLOCK:"SELF_TNT_BLOCK",ENEMY_BLACK_BLOCK:"ENEMY_BLACK_BLOCK",ENEMY_INCREASE_SPEED:"ENEMY_INCREASE_SPEED",ENEMY_BLIND:"ENEMY_BLIND",ENEMY_BLEACH:"ENEMY_BLEACH",ENEMY_MIRROR:"ENEMY_MIRROR"},Ye=[[0,0,0,0],[0,0,0,0],[1,1,0,0],[1,1,0,0]],$e=[[0,0,0,0],[0,0,0,0],[1,0,0,0],[1,1,0,0]],Xe=[[0,0,0,0],[0,1,0,0],[1,1,1,0],[0,1,0,0]],Fe=[[0,0,0,0],[0,0,0,0],[0,0,0,0],[1,0,0,0]],Ke=[[0,0,0,0],[0,0,0,0],[1,1,0,0],[0,1,1,0]],de=[[0,0,0,0],[0,0,0,0],[0,1,1,0],[1,1,0,0]],Ve=[[0,0,0,0],[1,0,0,0],[1,0,0,0],[1,1,0,0]],qe=[[0,0,0,0],[0,1,0,0],[0,1,0,0],[1,1,0,0]],Ze=[[0,0,0,0],[0,0,0,0],[0,1,0,0],[1,1,0,0]],je=[[1,0,0,0],[1,0,0,0],[1,0,0,0],[1,0,0,0]],Qe=[[0,0,0,0],[0,0,0,0],[1,0,0,1],[1,1,1,1]],Je={[O.Basic]:Fe,[O.Square]:Ye,[O.LShapeLeft]:qe,[O.LShapeRight]:Ve,[O.TShape]:Ze,[O.Line]:je,[O.ZShapeLeft]:Ke,[O.ZShapeRight]:de,[O.UShape]:Qe,[O.CornerShape]:$e,[O.PlusShape]:Xe};function m(e,l,o){return e+(l-e)*Math.max(0,Math.min(1,o))}function ze(e){const l=e.length,o=Array.from({length:l},()=>Array(l).fill(0));for(let c=0;c<l;c++)for(let s=0;s<l;s++)o[s][l-1-c]=e[c][s];return o}function J(e,l){let o=Je[e].map(s=>[...s]);const c=l/90;for(let s=0;s<c;s++)o=ze(o);return o}function H(e,l,o){const c=[];let s=e.length-1;for(let t=e.length-1;t>=0;t--)if(e[t].some(n=>n===1)){s=t;break}for(let t=0;t<e.length;t++)for(let n=0;n<e[t].length;n++)e[t][n]===1&&c.push({x:l+n,y:o+(s-t)});return c}function G(e,l,o,c=14,s=30){for(let t=s;t>=0;t--){const n=H(e,l,t);let r=!0;for(const i of n){if(i.x<0||i.x>=c||i.y<0){r=!1;break}if(i.y<o.length&&o[i.y][i.x]===1){r=!1;break}}if(!r)continue;const f=H(e,l,t-1);let u=!0;for(const i of f){if(i.x<0||i.x>=c||i.y<0){u=!1;break}if(i.y<o.length&&o[i.y][i.x]===1){u=!1;break}}if(!u)return t}return 0}function We(e,l=14){let o=0;for(let c=0;c<e.length;c++){let s=!0;for(let t=0;t<l;t++)if(e[c][t]!==1){s=!1;break}s&&o++}return o}function B(e,l=14){let o=0;for(let c=0;c<l;c++){let s=!1;for(let t=e.length-1;t>=0;t--)e[t][c]===1?s=!0:s&&e[t][c]===0&&o++}return o}function et(e,l,o=14){let c=0;for(const s of l)if(!(s.x<0||s.x>=o)){for(let t=s.y-1;t>=0;t--)if(!(t>=e.length)&&e[t][s.x]===0){let n=!1;for(let r=t-1;r>=0;r--)if(r<e.length&&e[r][s.x]===1){n=!0;break}if(n){c++;break}}}return c}function d(e,l=14){let o=0;for(let c=0;c<l;c++){let s=0;for(let t=e.length-1;t>=0;t--)e[t][c]===1?s++:s>0&&s>=3&&(o+=s)}return o}function V(e,l=14){let o=0;for(let c=0;c<l;c++){let s=!1,t=!1;for(let n=e.length-1;n>=0;n--)if(e[n][c]===1)s=!0;else if(s){t=!0;break}t&&o++}return o}function tt(e,l,o,c=14){if(o===0)return 0;const s=B(e,c),t=B(l,c),n=s-t;let r=0;return n>0&&(r+=n*500),s>0&&(r+=o*200),r}function nt(e,l=14){const o=[];for(let s=0;s<l;s++){let t=0;for(let n=e.length-1;n>=0;n--)if(e[n][s]===1){t=n+1;break}o.push(t)}let c=0;for(let s=0;s<o.length-1;s++)c+=Math.abs(o[s]-o[s+1]);return c}function ot(e){for(let l=e.length-1;l>=0;l--)if(e[l].some(o=>o===1))return l+1;return 0}function st(e,l=14){const o=[];for(let t=0;t<l;t++){let n=0;for(let r=e.length-1;r>=0;r--)if(e[r][t]===1){n=r+1;break}o.push(n)}const c=o.reduce((t,n)=>t+n,0)/o.length,s=o.reduce((t,n)=>t+(n-c)**2,0)/o.length;return Math.sqrt(s)}function ct(e,l=14){const o=[];for(let f=0;f<l;f++){let u=0;for(let i=e.length-1;i>=0;i--)if(e[i][f]===1){u=i+1;break}o.push(u)}const c=Math.min(...o),s=Math.max(...o),t=o.reduce((f,u)=>f+u,0)/l;let n=0;const r=s-c;r>=3&&(n+=(r-2)*(r-2)*2);for(const f of o){const u=Math.abs(f-t);u>=2&&(n+=u*u)}for(let f=1;f<l-1;f++)o[f]>o[f-1]+1&&o[f]>o[f+1]+1&&(n+=(o[f]-Math.min(o[f-1],o[f+1]))*3);return n}function lt(e,l=14,o=30){let c=0;for(let s=0;s<Math.min(e.length,o);s++)for(let t=0;t<l;t++)e[s][t]===1&&c++;return c}function rt(e,l,o=14){let c=0;const s=new Set(l.map(t=>t.y));for(const t of s){if(t<0||t>=e.length)continue;let n=0;for(let i=0;i<o;i++)e[t][i]===1&&n++;const r=l.filter(i=>i.y===t).length,f=n+r,u=f/o;u>=.7&&(c+=u*u*10),f===o&&(c+=20)}return c}function ft(e,l,o=14){let c=0;const s=new Set(l.map(t=>`${t.x},${t.y}`));for(const t of l){const n=t.y-1;if(n>0){const f=`${t.x},${n}`;if(!s.has(f)&&(n>=e.length||e[n][t.x]===0)){c-=10;continue}}const r=[{dx:-1,dy:0,isWall:t.x===0},{dx:1,dy:0,isWall:t.x===o-1},{dx:0,dy:-1,isWall:t.y===0},{dx:0,dy:1,isWall:!1}];for(const f of r){if(f.isWall){c+=3;continue}const u=t.x+f.dx,i=t.y+f.dy;s.has(`${u},${i}`)||i>=0&&i<e.length&&u>=0&&u<o&&e[i][u]===1&&(f.dy===0?c+=5:c+=2)}}return c}function at(e,l,o=14){const c=[];for(let n=0;n<o;n++){let r=0;for(let f=e.length-1;f>=0;f--)if(e[f][n]===1){r=f+1;break}c.push(r)}let s=0;const t=new Set(l.map(n=>n.x));for(const n of t){if(n<0||n>=o)continue;const r=c[n],f=n>0?c[n-1]:r+5,u=n<o-1?c[n+1]:r+5,a=Math.min(f,u)-r;if(a>=2){const _=l.filter(L=>L.x===n),E=Math.min(..._.map(L=>L.y)),y=Math.max(..._.map(L=>L.y))-E+1;s+=a*15+y*10,f>r&&u>r&&(s+=a*10)}}return s}function it(e,l,o=14){const c=[],s=new Set(l.map(a=>`${a.x},${a.y}`));for(let a=0;a<o;a++){let _=0;for(let E=e.length-1;E>=0;E--)if(e[E][a]===1||s.has(`${a},${E}`)){_=E+1;break}c.push(_)}let t=0;const n=c.reduce((a,_)=>a+_,0)/o,r=Math.min(...c),f=Math.max(...c),u=f-r;u>=4&&(t+=(u-3)*(u-3)*20);for(let a=0;a<o;a++){const _=c[a],E=a>0?c[a-1]:_,h=a<o-1?c[a+1]:_,y=(E+h)/2,L=_-y;L>=2&&(t+=L*L*15,_>E&&_>h&&(t+=L*25));const p=_-n;p>=3&&(t+=p*p*8);const C=_-r;C>=5&&(t+=(C-4)*(C-4)*12)}const i=new Set(l.map(a=>a.x));for(const a of i)a<0||a>=o||c[a]===f&&c[a]>n+2&&(t+=50);return t}function ut(e,l,o=14){const c=new Set(l.map(y=>`${y.x},${y.y}`)),s=[];for(let y=0;y<o;y++){let L=0;for(let p=e.length-1;p>=0;p--)if(e[p][y]===1||c.has(`${y},${p}`)){L=p+1;break}s.push(L)}let t=0,n=0;const r=s[0],f=s[o-1],u=s.slice(1,-1),i=u.reduce((y,L)=>y+L,0)/(o-2),a=Math.max(...u),_=4,E=12;if(f<i-2&&i<E){const y=Math.min(i-f,_);t+=y*4}if(r<i-2&&i<E){const y=Math.min(i-r,_);t+=y*3}if(a>i+3){const y=a-i;n+=y*10}const h=new Set(l.map(y=>y.x));if(h.has(0)||h.has(o-1)){const y=h.has(o-1)?o-1:0;(y===0?s[1]:s[o-2])>s[y]+3&&(n+=30)}return{bonus:t,penalty:n}}function ht(e){switch(e){case 1:return 100;case 2:return 300;case 3:return 600;case 4:return 1200;default:return e>4?1200+(e-4)*400:0}}function q(e,l=14){let o=0;for(let c=0;c<l;c++)for(let s=e.length-1;s>=0;s--)e[s][c];return o}function Z(e,l=14){const o=[];for(let t=0;t<l;t++){let n=0;for(let r=e.length-1;r>=0;r--)if(e[r][t]===1){n=r+1;break}o.push(n)}let c=0,s=1;for(let t=1;t<l;t++)Math.abs(o[t]-o[t-1])<=1?s++:(s>=3&&(c+=s*s),s=1);return s>=3&&(c+=s*s),c}function _t(e,l=14){let o=0;const c=[];for(let s=0;s<l;s++){let t=0;for(let n=e.length-1;n>=0;n--)if(e[n][s]===1){t=n+1;break}c.push(t)}for(let s=0;s<l;s++){const t=s>0?c[s-1]:c[s]+10,n=s<l-1?c[s+1]:c[s]+10,r=c[s],f=t-r,u=n-r;if(f>=3&&u>=3){const i=Math.min(f,u);i>=4?o+=i*20:o+=i*8}}return o}function yt(e,l=14){let o=0;for(let c=0;c<e.length;c++){let s=!1;for(let n=0;n<l;n++)if(e[c][n]===1){s=!0;break}if(!s)continue;let t=1;for(let n=0;n<l;n++){const r=e[c][n];r!==t&&o++,t=r}t!==1&&o++}return o}function Et(e){switch(e){case I.NORMAL:return 0;case I.BRONZE:return 1;case I.SILVER:return 2;case I.GOLD:return 3;case I.DIAMOND:return 4;default:return 0}}function pt(e,l,o,c=14){let s=0;const t=[{dx:-1,dy:0},{dx:1,dy:0},{dx:0,dy:-1},{dx:0,dy:1}],n=new Set(l.map(r=>`${r.x},${r.y}`));for(const r of l)for(const f of t){const u=r.x+f.dx,i=r.y+f.dy;if(!n.has(`${u},${i}`)&&i>=0&&i<e.length&&u>=0&&u<c){const a=e[i][u];a&&a.color===o&&s++}}return s}function Lt(e,l,o,c=14,s=30){let t=0;for(const n of l)for(let r=3;r<=6;r++){const f=Ct(e,n,r,o,c,s);t+=f*(r===6?4:r===5?3:r===4?2:1)}return t}function Ct(e,l,o,c,s,t){let n=0;for(let r=Math.max(0,l.y-o+1);r<=l.y;r++)for(let f=Math.max(0,l.x-o+1);f<=l.x;f++){if(f+o>s||r+o>t)continue;let u=0;const i=o*o;for(let _=r;_<r+o;_++)for(let E=f;E<f+o;E++)if(_<e.length){const h=e[_][E];h&&h.color===c&&u++}const a=u/i;if(a>=.3){const _=a*a*10;_>n&&(n=_)}}return n}function St(e,l,o,c=14){const s=new Set;let t=0,n=!1;const r=new Set(l.map(u=>`${u.x},${u.y}`)),f=[{dx:-1,dy:0},{dx:1,dy:0},{dx:0,dy:-1},{dx:0,dy:1}];for(let u=0;u<e.length;u++)for(let i=0;i<c;i++){const a=`${i},${u}`;if(s.has(a))continue;const _=e[u][i];if(_&&_.color===o){const E=[],h=new Set,y=[{x:i,y:u}];for(;y.length>0;){const p=y.pop();if(!p)continue;const C=`${p.x},${p.y}`;if(h.has(C)||p.x<0||p.x>=c||p.y<0||p.y>=e.length)continue;const S=e[p.y][p.x];!S||S.color!==o||(h.add(C),s.add(C),E.push(p),y.push({x:p.x-1,y:p.y}),y.push({x:p.x+1,y:p.y}),y.push({x:p.x,y:p.y-1}),y.push({x:p.x,y:p.y+1}))}const L=E.length;L>t&&(t=L,n=E.some(p=>{for(const C of f){const S=p.x+C.dx,g=p.y+C.dy;if(r.has(`${S},${g}`))return!0}return!1}))}}return n&&t>=4?Math.sqrt(t)*3:0}function mt(e,l,o,c=14){let s=0;const t=3;for(const n of l)for(let r=-t;r<=t;r++)for(let f=-t;f<=t;f++){const u=n.x+f,i=n.y+r;if(u<0||u>=c||i<0||i>=e.length)continue;const a=e[i][u];if(a&&a.color===o){const _=Et(a.tier);if(_>0){const E=Math.abs(f)+Math.abs(r),h=(t+1-E)/t;s+=_*h*5}}}return s}function xt(e,l,o,c,s=14,t=30){let n=0;const r=pt(e,l,o,s);n+=r*2;const f=Lt(e,l,o,s,t);n+=f;const u=St(e,l,o,s);n+=u,c<30&&(n*=1.5);const i=mt(e,l,o,s);return n+=i,n}function j(e,l,o,c,s,t,n=14,r=30){const f=c.map(R=>[...R]),u=s.map(R=>[...R]),i=H(e,l,o);for(const R of i)R.y>=0&&R.y<f.length&&R.x>=0&&R.x<n&&(f[R.y][R.x]=1,u[R.y][R.x]={color:t,tier:I.NORMAL});const a=We(f,n),_=B(c,n),E=B(f,n),h=Math.max(0,_-E),y=Math.max(0,E-_),L=nt(f,n),p=ot(f),C=st(f,n),S=lt(f,n,r),g=d(c,n),w=d(f,n),P=V(c,n),A=V(f,n),z=et(c,i,n),W=gt(f,n),ee=tt(c,W,a,n),te=rt(c,i,n),v=xt(u,i,t,S,n,r),ne=ft(c,i,n),oe=at(c,i,n),se=it(f,i,n),k=ut(f,i,n),ce=ht(a),le=q(f,n),re=q(c,n),fe=Z(f,n),ae=Z(c,n),ie=fe-ae,ue=_t(f,n),he=yt(f,n),_e=ct(f,n),M=r*.5,Y=Math.min(1,Math.max(0,(p-M)/(r-M))),ye=Math.min(1,_/8),Ee=Math.min(1,g/10),$=Math.max(ye,Ee*.8),x=Math.min(1,Y+$*.5),pe=m(30,2,x),Le=m(1500,4e3,x),Ce=m(800,2500,x),Se=m(1e3,3e3,x),me=m(400,1200,x),xe=m(100,500,x),ge=m(8,100,Y),Re=m(40,15,x),Oe=m(15,5,x),X=m(200,600,x),F=m(200,500,x),Ne=m(1,2.5,$),He=m(20,10,x),Ie=m(50,100,x),we=m(80,150,x),K=m(15,3,x),De=m(1.5,1,x),Te=m(100,250,x),Be=m(20,8,x),be=m(50,120,x),Ue=m(15,6,x),Ge=m(60,30,x),Pe=Math.max(0,g-w),Ae=Math.max(0,w-g),ve=Math.max(0,P-A),ke=Math.max(0,A-P),Me=Math.max(0,le-re);return{score:ce*De+h*me+ee*Ne+te*xe+ne*He+oe*Ie+k.bonus*K+ie*Be+Pe*X+ve*F+v*pe+-z*Se+-se*we+-k.penalty*K+-y*Le+-E*Ce+-Ae*X*1.5+-ke*F+-Me*Te+-ue*be+-he*Ue+-_e*Ge+-L*Re+-p*ge+-C*Oe,linesCleared:a,colorBonusScore:v}}function gt(e,l=14){const o=e.map(s=>[...s]),c=[];for(let s=0;s<o.length;s++){let t=!0;for(let n=0;n<l;n++)if(o[s][n]!==1){t=!1;break}t&&c.push(s)}c.sort((s,t)=>t-s);for(const s of c){for(let t=s;t<o.length-1;t++)o[t]=[...o[t+1]];o[o.length-1]=Array(l).fill(0)}return o}function Rt(e,l=14,o=30){return Array.from({length:o+10},(s,t)=>t<e.length?[...e[t]]:Array(l).fill(0))}function Ot(e,l=14,o=30){return Array.from({length:o+10},(s,t)=>t<e.length?[...e[t]]:Array(l).fill(null))}function T(e,l,o,c,s,t){const n=H(e,l,o);for(const r of n)if(r.x<0||r.x>=s||r.y<0||r.y>=t||r.y<c.length&&c[r.y][r.x]===1)return!1;return!0}function Nt(e,l,o,c,s){const t=H(e,l,o);for(const n of t){if(n.y===0)return!0;const r=n.y-1;if(r>=0&&r<c.length&&n.x>=0&&n.x<s&&c[r][n.x]===1&&!t.some(u=>u.x===n.x&&u.y===r))return!0}return!1}function Ht(e,l,o,c,s){const t=[],n=new Set;for(let r=0;r<c;r++){if(!H(e,r,s).every(E=>E.x>=0&&E.x<c))continue;const i=G(e,r,o,c,s);if(i<0)continue;const a=[{x:r,y:i}],_=new Set;for(_.add(`${r},${i}`);a.length>0;){const E=a.shift();if(!E)continue;const h=E.x-1,y=`${h},${E.y}`;if(!_.has(y)&&T(e,h,E.y,o,c,s)){_.add(y),a.push({x:h,y:E.y});let C=E.y;for(;C>0&&T(e,h,C-1,o,c,s);){C--;const S=`${h},${C}`;_.has(S)||(_.add(S),a.push({x:h,y:C}))}}const L=E.x+1,p=`${L},${E.y}`;if(!_.has(p)&&T(e,L,E.y,o,c,s)){_.add(p),a.push({x:L,y:E.y});let C=E.y;for(;C>0&&T(e,L,C-1,o,c,s);){C--;const S=`${L},${C}`;_.has(S)||(_.add(S),a.push({x:L,y:C}))}}}for(const E of _){if(n.has(E))continue;const[h,y]=E.split(",").map(Number);Nt(e,h,y,o,c)&&(n.add(E),t.push({x:h,y}))}}return t}function D(e,l,o,c=14,s=30){const t=[],n=new Set,r=[0,90,180,270];for(const f of r){const u=J(e.blockType,f);for(let a=0;a<c;a++){if(!H(u,a,s).every(g=>g.x>=0&&g.x<c))continue;const h=G(u,a,l,c,s);if(h<0)continue;const y=`${a},${h},${f}`;if(n.has(y))continue;const L=H(u,a,h);if(L.some(g=>g.y<l.length&&g.y>=0&&l[g.y][g.x]===1)||L.some(g=>g.y>=s))continue;n.add(y);const S=j(u,a,h,l,o,e.color,c,s);t.push({x:a,y:h,rotation:f,score:S.score,linesCleared:S.linesCleared,colorBonusScore:S.colorBonusScore})}const i=Ht(u,f,l,c,s);for(const a of i){const _=`${a.x},${a.y},${f}`;if(n.has(_)||H(u,a.x,a.y).some(L=>L.y>=s))continue;n.add(_);const y=j(u,a.x,a.y,l,o,e.color,c,s);t.push({x:a.x,y:a.y,rotation:f,score:y.score,linesCleared:y.linesCleared,colorBonusScore:y.colorBonusScore})}}return t}function b(e,l,o,c,s,t=14,n=30,r){const f=J(e.blockType,o),u=r??G(f,l,c,t,n),i=H(f,l,u),a=c.map(h=>[...h]),_=s.map(h=>[...h]);for(const h of i)h.y>=0&&h.y<a.length&&h.x>=0&&h.x<t&&(a[h.y][h.x]=1,_[h.y][h.x]={color:e.color,tier:I.NORMAL});const E=[];for(let h=0;h<a.length;h++){let y=!0;for(let L=0;L<t;L++)if(a[h][L]!==1){y=!1;break}y&&E.push(h)}if(E.length>0){E.sort((h,y)=>y-h);for(const h of E){for(let y=h;y<a.length-1;y++)a[y]=[...a[y+1]],_[y]=[..._[y+1]];a[a.length-1]=Array(t).fill(0),_[_.length-1]=Array(t).fill(null)}}return{newGridMatrix:a,newColorMatrix:_,linesCleared:E.length}}const U=8,It=.7,wt=.5,Dt=5;function Q(e){if(e.powerUps.length===0)return null;const l=e.maxHeight/e.gridHeight,o=Math.floor(e.linesCleared/10)+1,c=l>=It,s=l>=wt,t=o>=Dt;for(let n=0;n<e.powerUps.length;n++)switch(e.powerUps[n]){case N.ENEMY_BLACK_BLOCK:case N.ENEMY_INCREASE_SPEED:case N.ENEMY_BLIND:case N.ENEMY_BLEACH:case N.ENEMY_MIRROR:return n}for(let n=0;n<e.powerUps.length;n++)switch(e.powerUps[n]){case N.SELF_NUKE:if(c)return n;break;case N.SELF_TNT_BLOCK:if(s)return n;break;case N.SELF_REDUCE_SPEED:if(t)return n;break;case N.SELF_REMOVE_EFFECT_BLOCKS:if(e.hasBlackOrWhiteBlocks)return n;break;case N.SELF_RAINBOW_BLOCK:if(e.powerUps.length>=3)return n;break}return null}function Tt(e){const l=Rt(e.occupancy,e.gridWidth,e.gridHeight),o=Ot(e.colorMatrix,e.gridWidth,e.gridHeight),c=D(e.currentBlock,l,o,e.gridWidth,e.gridHeight);if(c.length===0)return{x:Math.floor(e.gridWidth/2),y:e.gridHeight-1,rotation:0,shouldSwap:!1,score:-1/0,simulations:0,usePowerUpIndex:Q(e)};c.sort((i,a)=>a.score-i.score);const s=c.slice(0,U);let t=null,n=-1/0;for(const i of s){const{newGridMatrix:a,newColorMatrix:_,linesCleared:E}=b(e.currentBlock,i.x,i.rotation,l,o,e.gridWidth,e.gridHeight,i.y),h=D(e.nextBlock,a,_,e.gridWidth,e.gridHeight);let y=0;if(h.length>0){if(h.sort((p,C)=>C.score-p.score),y=h[0].score,h.length>0){const{newGridMatrix:p,newColorMatrix:C}=b(e.nextBlock,h[0].x,h[0].rotation,a,_,e.gridWidth,e.gridHeight,h[0].y),S=D(e.nextNextBlock,p,C,e.gridWidth,e.gridHeight);S.length>0&&(S.sort((g,w)=>w.score-g.score),y+=S[0].score*.5)}}else y=-1e4;const L=i.score+y*.7+E*500;L>n&&(n=L,t=i)}let r=!1;const f=D(e.swapBlock,l,o,e.gridWidth,e.gridHeight);if(f.length>0){f.sort((E,h)=>h.score-E.score);const i=f.slice(0,U);let a=-1/0,_=null;for(const E of i){const{newGridMatrix:h,newColorMatrix:y,linesCleared:L}=b(e.swapBlock,E.x,E.rotation,l,o,e.gridWidth,e.gridHeight,E.y),p=D(e.nextBlock,h,y,e.gridWidth,e.gridHeight);let C=0;p.length>0?(p.sort((g,w)=>w.score-g.score),C=p[0].score):C=-1e4;const S=E.score+C*.7+L*500;S>a&&(a=S,_=E)}a>n+200&&_&&(r=!0,t=_,n=a)}t||(t=c[0]);const u=Q(e);return{x:t.x,y:t.y,rotation:t.rotation,shouldSwap:r,score:n,simulations:s.length*U,usePowerUpIndex:u}}self.onmessage=e=>{const l=e.data;switch(l.type){case"COMPUTE":{try{const c={type:"RESULT",placement:Tt(l.state)};self.postMessage(c)}catch(o){const c={type:"ERROR",message:o instanceof Error?o.message:"Unknown error"};self.postMessage(c)}break}}};self.postMessage({type:"READY"});
